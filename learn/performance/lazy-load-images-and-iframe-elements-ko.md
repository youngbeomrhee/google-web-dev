# 이미지와 `<iframe>` 요소의 지연 로딩

이미지와 `<iframe>` 요소는 다른 유형의 리소스보다 더 많은 대역폭을 소비하는 경우가 많습니다. `<iframe>` 요소의 경우, 그 안에 있는 페이지를 로드하고 렌더링하는 데 상당한 추가 처리 시간이 소요될 수 있습니다.

이미지의 지연 로딩의 경우, 초기 뷰포트 외부에 있는 이미지의 로딩을 지연시키는 것이 초기 뷰포트 내의 더 중요한 리소스에 대한 대역폭 경쟁을 줄이는 데 도움이 될 수 있습니다. 이는 네트워크 연결이 좋지 않은 경우 페이지의 가장 큰 콘텐츠 페인트(LCP)를 개선할 수 있으며, 재할당된 대역폭은 LCP 후보가 더 빠르게 로드되고 페인트되도록 도울 수 있습니다.

`<iframe>` 요소와 관련하여, 페이지의 다음 페인트와의 상호작용(INP)은 시작 시 지연 로딩을 통해 개선될 수 있습니다. 이는 `<iframe>`이 자체 하위 리소스를 가진 완전히 별개의 HTML 문서이기 때문입니다. `<iframe>` 요소는 별도의 프로세스에서 실행될 수 있지만, 다른 스레드와 프로세스를 공유하는 경우가 드물지 않으며, 이는 페이지가 사용자 입력에 덜 반응하게 되는 조건을 만들 수 있습니다.

따라서 화면 밖의 이미지와 `<iframe>` 요소의 로딩을 지연시키는 것은 추구할 가치가 있는 기술이며, 성능 측면에서 상당히 좋은 결과를 얻기 위해 비교적 적은 노력이 필요합니다. 이 모듈은 페이지의 중요한 시작 기간 동안 더 빠르고 나은 사용자 경험을 위해 이 두 가지 유형의 요소를 지연 로딩하는 방법을 설명합니다.

## 로딩 속성으로 이미지 지연 로딩

로딩 속성은 `<img>` 요소에 추가되어 브라우저가 이미지를 어떻게 로드해야 하는지 알려줄 수 있습니다:

- "eager"는 브라우저에게 이미지가 초기 뷰포트 외부에 있더라도 즉시 로드해야 함을 알립니다. 이는 로딩 속성의 기본값이기도 합니다.
- "lazy"는 이미지가 보이는 뷰포트에서 설정된 거리 내에 있을 때까지 이미지 로딩을 지연시킵니다. 이 거리는 브라우저마다 다르지만, 사용자가 스크롤할 때 이미지가 로드될 수 있을 만큼 충분히 크게 설정되는 경우가 많습니다.

> [!IMPORTANT]
> 앞서 언급했듯이, 로딩="lazy" 속성을 사용할 때 브라우저가 이미지가 필요하다고 결정하는 뷰포트에서의 거리는 브라우저마다 다릅니다. 관련된 요소로는 효과적인 연결 유형과 이미지의 유형이 있을 수 있습니다.

`<picture>` 요소를 사용하는 경우에도 로딩 속성은 여전히 자식 `<img>` 요소에 적용되어야 하며, `<picture>` 요소 자체에는 적용되지 않아야 합니다. 이는 `<picture>` 요소가 다른 이미지 후보를 가리키는 추가 `<source>` 요소를 포함하는 컨테이너이기 때문이며, 브라우저가 선택한 후보는 자식 `<img>` 요소에 직접 적용됩니다.

### 초기 뷰포트에 있는 이미지를 지연 로딩하지 마세요

로딩="lazy" 속성은 초기 뷰포트 외부에 위치한 `<img>` 요소에만 추가해야 합니다. 그러나 페이지가 렌더링되기 전에 요소가 뷰포트 내에서 상대적으로 정확한 위치를 아는 것은 복잡할 수 있습니다. 다양한 뷰포트 크기, 종횡비 및 장치를 고려해야 합니다.

예를 들어, 데스크톱 뷰포트는 모바일 전화의 뷰포트와 상당히 다를 수 있으며, 이는 물리적으로 작은 장치의 초기 뷰포트에 나타나지 않을 이미지를 초기 뷰포트에 맞출 수 있습니다. 세로 방향으로 사용되는 태블릿도 상당한 양의 세로 공간을 표시하며, 일부 데스크톱 장치보다 더 많은 공간을 표시할 수 있습니다.

그러나 로딩="lazy"를 적용하지 말아야 할 경우가 명확한 경우도 있습니다. 예를 들어, 히어로 이미지의 경우나 `<img>` 요소가 모든 장치에서 레이아웃의 상단 또는 상단 근처에 나타날 가능성이 있는 다른 이미지 사용 사례에서는 로딩="lazy" 속성을 생략해야 합니다. 이는 LCP 후보가 될 가능성이 있는 이미지의 경우 더욱 중요합니다.

지연 로딩된 이미지는 브라우저가 레이아웃을 완료할 때까지 이미지의 최종 위치가 뷰포트 내에 있는지 알기 위해 기다려야 합니다. 이는 보이는 뷰포트에 있는 `<img>` 요소에 로딩="lazy" 속성이 있는 경우, 모든 CSS가 다운로드되고 파싱되어 페이지에 적용된 후에만 요청된다는 것을 의미합니다. 이는 원시 마크업에서 프리로드 스캐너에 의해 발견되자마자 가져오는 것과는 다릅니다.

`<img>` 요소의 로딩 속성은 모든 주요 브라우저에서 지원되므로, 이미지를 지연 로딩하기 위해 JavaScript를 사용할 필요가 없습니다. 브라우저가 이미 제공하는 기능을 제공하기 위해 페이지에 추가 JavaScript를 추가하는 것은 INP와 같은 페이지 성능의 다른 측면에 영향을 미칩니다.

> [!NOTE]
> 로딩 속성은 이미지의 네트워크 우선 순위에 영향을 미치지 않습니다. 네트워크 우선 순위를 조정하려면 Fetch Priority API를 사용할 수 있습니다. fetchpriority="high" 및 로딩="lazy"가 있는 보이는 뷰포트의 이미지는 여전히 모든 CSS가 다운로드되고 파싱될 때까지 기다립니다.

### 이미지 지연 로딩 데모

## `<iframe>` 요소 지연 로딩

`<iframe>` 요소를 뷰포트에서 보일 때까지 지연 로딩하면 상당한 데이터를 절약하고 최상위 페이지 로드에 필요한 중요한 리소스의 로딩을 개선할 수 있습니다. 또한 `<iframe>` 요소는 본질적으로 최상위 문서 내에 로드된 전체 HTML 문서이므로, 상당한 수의 하위 리소스, 특히 JavaScript를 포함할 수 있으며, 이러한 프레임 내의 작업이 상당한 처리 시간을 요구하는 경우 페이지의 INP에 상당한 영향을 미칠 수 있습니다.

타사 임베드는 `<iframe>` 요소의 일반적인 사용 사례입니다. 예를 들어, 임베드된 비디오 플레이어나 소셜 미디어 게시물은 일반적으로 `<iframe>` 요소를 사용하며, 이들은 또한 최상위 페이지의 리소스에 대한 대역폭 경쟁을 초래할 수 있는 상당한 수의 하위 리소스를 요구하는 경우가 많습니다. 예를 들어, YouTube 비디오의 임베드를 지연 로딩하면 초기 페이지 로드 중에 500KiB 이상을 절약할 수 있으며, Facebook 좋아요 버튼 플러그인을 지연 로딩하면 200KiB 이상을 절약할 수 있습니다. 대부분은 JavaScript입니다.

어쨌든 페이지의 접힌 부분 아래에 `<iframe>`이 있는 경우, 이를 지연 로딩하는 것을 강력히 고려해야 합니다. 이는 사용자 경험을 크게 개선할 수 있기 때문입니다.

### `<iframe>` 요소의 로딩 속성

`<iframe>` 요소의 로딩 속성은 모든 주요 브라우저에서 지원됩니다. 로딩 속성의 값과 동작은 `<img>` 요소의 로딩 속성과 동일합니다:

- "eager"는 기본값입니다. 브라우저에게 `<iframe>` 요소의 HTML과 하위 리소스를 즉시 로드하도록 알립니다.
- "lazy"는 `<iframe>` 요소의 HTML과 하위 리소스를 뷰포트에서 미리 정의된 거리 내에 있을 때까지 로딩을 지연시킵니다.

> [!NOTE]
> Chrome은 레이아웃 이동을 피하기 위해 지연 로딩된 `<iframe>`이 여전히 가져오는 동안 공간을 예약하고 플레이스홀더를 표시합니다. 그러나 여전히 `<iframe>` 요소의 너비와 높이 속성 및 CSS의 추가 스타일링을 사용하여 레이아웃 이동을 최소화해야 합니다.

### `<iframe>` 지연 로딩 데모

## 파사드

페이지 로드 중에 임베드를 즉시 로드하는 대신, 사용자 상호작용에 응답하여 필요할 때 로드할 수 있습니다. 이는 사용자가 상호작용할 때까지 이미지나 다른 적절한 HTML 요소를 표시함으로써 이루어질 수 있습니다. 사용자가 요소와 상호작용하면 타사 임베드로 교체할 수 있습니다. 이 기술은 파사드로 알려져 있습니다.

파사드의 일반적인 사용 사례는 타사 서비스의 비디오 임베드입니다. 임베드는 비디오 콘텐츠 자체 외에도 많은 추가적이고 잠재적으로 비싼 하위 리소스(예: JavaScript)를 로드할 수 있습니다. 이러한 경우, 비디오가 자동 재생되어야 할 정당한 필요가 없는 한, 비디오 임베드는 사용자가 재생 버튼을 클릭하여 재생하기 전에 상호작용해야 합니다.

이는 비디오 임베드와 시각적으로 유사한 정적 이미지를 표시하고 프로세스에서 상당한 대역폭을 절약할 수 있는 주요 기회입니다. 사용자가 이미지를 클릭하면 실제 `<iframe>` 임베드로 교체되어 타사 `<iframe>` 요소의 HTML과 하위 리소스가 다운로드를 시작합니다.

초기 페이지 로드를 개선하는 것 외에도 또 다른 주요 장점은 사용자가 비디오를 재생하지 않으면 이를 제공하는 데 필요한 리소스가 다운로드되지 않는다는 것입니다. 이는 사용자가 실제로 원하는 것만 다운로드하도록 보장하는 좋은 패턴입니다.

채팅 위젯은 파사드 기술의 또 다른 훌륭한 사용 사례입니다. 대부분의 채팅 위젯은 페이지 로드와 사용자 입력에 대한 반응성을 부정적으로 영향을 미칠 수 있는 상당한 양의 JavaScript를 다운로드합니다. 모든 것을 앞서 로드하는 것과 마찬가지로, 비용은 로드 시간에 발생하지만, 채팅 위젯의 경우 모든 사용자가 상호작용할 의도가 있는 것은 아닙니다.

반면에 파사드를 사용하면 타사의 "채팅 시작" 버튼을 가짜 버튼으로 교체할 수 있습니다. 사용자가 의미 있게 상호작용하면(예: 일정 시간 동안 포인터를 올려놓거나 클릭) 실제 기능적인 채팅 위젯이 사용자가 필요할 때 자리에 배치됩니다.

자신의 파사드를 구축하는 것도 가능하지만, YouTube 비디오용 lite-youtube-embed, Vimeo 비디오용 lite-vimeo-embed, 채팅 위젯용 React Live Chat Loader와 같은 더 인기 있는 타사에 대한 오픈 소스 옵션도 있습니다.

## JavaScript 지연 로딩 라이브러리

`<video>` 요소, `<video>` 요소 포스터 이미지, CSS 배경 이미지 속성으로 로드된 이미지 또는 다른 지원되지 않는 요소를 지연 로딩해야 하는 경우, lazysizes 또는 yall.js와 같은 JavaScript 기반 지연 로딩 솔루션을 사용할 수 있습니다. 이러한 유형의 리소스를 지연 로딩하는 것은 브라우저 수준의 기능이 아닙니다.

특히, 오디오 트랙이 없는 자동 재생 및 반복 `<video>` 요소는 시각적 품질이 동등한 비디오 리소스보다 여러 배 더 클 수 있는 애니메이션 GIF를 사용하는 것보다 훨씬 효율적인 대안입니다. 그럼에도 불구하고 이러한 비디오는 대역폭 측면에서 여전히 상당할 수 있으므로, 이를 지연 로딩하는 것은 낭비된 대역폭을 줄이는 데 큰 도움이 될 수 있는 추가 최적화입니다.

이러한 라이브러리의 대부분은 Intersection Observer API를 사용하여 작동하며, 페이지의 HTML이 초기 로드 후 변경되는 경우 Mutation Observer API도 사용하여 요소가 사용자의 뷰포트에 들어갈 때 인식합니다. 이미지가 보이거나 뷰포트에 접근하면 JavaScript 라이브러리는 비표준 속성(종종 data-src 또는 유사한 속성)을 올바른 속성(src)으로 교체합니다.

애니메이션 GIF를 대체하는 비디오가 있다고 가정하고, 이를 JavaScript 솔루션으로 지연 로딩하고 싶습니다. 이는 다음과 같은 마크업 패턴으로 yall.js로 가능합니다:

```html
<!-- 자동 재생을 위해 autoplay, loop, muted 및 playsinline 속성을 사용합니다. -->
<video class="lazy" autoplay loop muted playsinline width="320" height="480">
  <source data-src="video.webm" type="video/webm">
  <source data-src="video.mp4" type="video/mp4">
</video>
```

기본적으로 yall.js는 "lazy" 클래스가 있는 모든 적격 HTML 요소를 관찰합니다. yall.js가 페이지에 로드되고 실행되면, 사용자가 뷰포트로 스크롤할 때까지 비디오는 로드되지 않습니다. 그 시점에서 `<video>` 요소의 자식 `<source>` 요소의 data-src 속성이 src 속성으로 교체되어 비디오를 다운로드하고 자동으로 재생을 시작합니다.

### 지식을 테스트하세요

- `<img>` 및 `<iframe>` 요소의 로딩 속성의 기본값은 무엇입니까?  
  ◯ "lazy"  
  ◯ "eager"

- JavaScript 기반 지연 로딩 솔루션을 사용하는 것이 합리적인 경우는 언제입니까?  
  ◯ 로딩 속성이 지원되지 않는 리소스의 경우, 예를 들어 애니메이션 이미지를 대체하기 위한 자동 재생 비디오의 경우 또는 `<video>` 요소의 포스터 이미지를 지연 로드하기 위한 경우.  
  ◯ 지연 로드할 수 있는 모든 리소스의 경우.

- 파사드가 유용한 기술인 경우는 언제입니까?  
  ◯ 로드하는 데 필요한 리소스가 상당할 뿐만 아니라 모든 사용자가 상호작용할 가능성이 없는 타사 임베드의 경우.  
  ◯ 사용자의 필요와 관계없이 상당한 데이터를 소비하는 모든 타사 임베드의 경우.

## 다음: 프리페칭 및 프리렌더링

이제 이미지와 `<iframe>` 요소의 지연 로딩을 다루었으므로, 페이지가 더 빠르게 로드되면서 사용자의 요구를 존중할 수 있도록 할 수 있습니다. 그러나 리소스의 추측 로딩이 바람직할 수 있는 경우가 있습니다. 다음 모듈에서는 프리페칭 및 프리렌더링에 대해 배우고, 이러한 기술이 신중하게 사용될 때 다음 페이지로의 탐색을 사전에 로드하여 상당히 빠르게 할 수 있는 방법을 배웁니다.

